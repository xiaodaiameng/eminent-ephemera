<!-- MusicPlayer.astro -->
<button 
  id="global-music-toggle"
  style="
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    z-index: 9999;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    border: 2px solid rgba(255, 174, 174, 0.982);
    background: white;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(255, 152, 152, 0.2);
    transition: all 0.3s ease;
  "
  title="æ’­æ”¾/æš‚åœéŸ³ä¹"
>
  ğŸµ
</button>

<script>
// ä½¿ç”¨é—­åŒ…æ–¹æ¡ˆï¼Œå®Œå…¨é¿å…å…¨å±€å˜é‡
(() => {
  console.log('=== éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ– ===');
  
  const button = document.getElementById('global-music-toggle');
  if (!button) {
    console.error('æ‰¾ä¸åˆ°æ’­æ”¾æŒ‰é’®');
    return;
  }
  
  // åˆ›å»ºé—­åŒ…å†…çš„ç§æœ‰å˜é‡
  let audio = null;
  let isPlaying = false;
  let isInitialized = false;
  let isFromNavigation = false; // æ ‡è®°æ˜¯å¦æ¥è‡ªé¡µé¢è·³è½¬
  let currentSongFinished = false; // æ ‡è®°å½“å‰æ­Œæ›²æ˜¯å¦å·²æ’­æ”¾å®Œæ¯•
  
  const musicList = [
    '/music/CallofSilence_pure.mp3',
    '/music/FarAwayfromHome.mp3',
    '/music/NormalNoMore_pure.mp3',
    '/music/ä¸–ç•Œé‚£ä¹ˆå¤§è¿˜æ˜¯é‡è§ä½ .mp3',
    '/music/æ™´å¤©.mp3',
    '/music/ä¸–é—´ç¾å¥½ä¸ä½ ç¯ç¯ç›¸æ‰£.mp3',
    '/music/ä½ çš„åå­—.mp3',
    '/music/åŒ†åŒ†é‚£å¹´.mp3',
    '/music/åšäººä¼ ä¸»é¢˜æ›².mp3',
    '/music/åƒåƒé˜™æ­Œ.mp3',
    '/music/åšäººä¼ f2.mp3',
    '/music/åŸå—èŠ±å·²å¼€_pure.mp3',
    '/music/åšäººä¼ f3.mp3',
    '/music/å‘Šç™½ä¹‹å¤œ_pure.mp3',
    '/music/å®¾å…‹æ–¯çš„ç¾é…’.mp3',
    '/music/æµ·è´¼ç‹_é£çš„å»å‘.mp3',
    '/music/å¹´è½®.mp3',
    '/music/å¿«ä¹çš„é˜³å…‰_pure.mp3',
    '/music/æƒ…æ­Œ.mp3',
    '/music/æˆ‘ç”¨ä»€ä¹ˆæŠŠä½ ç•™ä½.mp3',
    '/music/æ•¢é—®è·¯åœ¨ä½•æ–¹.mp3',
    '/music/æœ‰ä½•ä¸å¯.mp3',
    '/music/æœªé—»èŠ±å.mp3',
    '/music/æ¢ç¥1_3pure.mp3',
    '/music/æ°´æ˜Ÿè®°_pure.mp3',
    '/music/æµ·åº•_å››å›½è¯­è¨€.mp3',
    '/music/ç«å½±å¿è€…_è¤ä¹‹å…‰.mp3',
    '/music/ç¬‘çœ‹é£äº‘.mp3',
    '/music/èŠæ¬¡éƒçš„å¤å¤©_pure.mp3',
    '/music/é›¨å¤©.mp3',
    '/music/äººç”Ÿä½•å¤„ä¸ç›¸é€¢.mp3'
  ];
  let currentIndex = 0;
  
  // é¡µé¢è·³è½¬æ ‡è®°
  function markAsNavigation() {
    isFromNavigation = true;
    sessionStorage.setItem('music-from-navigation', 'true');
    console.log('æ ‡è®°ä¸ºé¡µé¢è·³è½¬çŠ¶æ€');
  }
  
  // æ£€æŸ¥æ˜¯å¦æ¥è‡ªé¡µé¢è·³è½¬
  function checkIfFromNavigation() {
    const fromNav = sessionStorage.getItem('music-from-navigation') === 'true';
    if (fromNav) {
      console.log('æ£€æµ‹åˆ°é¡µé¢è·³è½¬ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½ç»§ç»­æ’­æ”¾');
      isFromNavigation = true;
    }
    return fromNav;
  }
  
  // åˆå§‹åŒ–éŸ³é¢‘
  function initAudio() {
    if (isInitialized) {
      return;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ¥è‡ªé¡µé¢è·³è½¬
    const fromNavigation = checkIfFromNavigation();
    
    // ä»æœ¬åœ°å­˜å‚¨æ¢å¤çŠ¶æ€
    try {
      const savedState = localStorage.getItem('music-state');
      const savedTime = localStorage.getItem('music-time');
      const savedIndex = localStorage.getItem('music-index');
      const savedFinished = localStorage.getItem('music-finished');
      
      if (savedIndex !== null) {
        currentIndex = parseInt(savedIndex);
      }
      
      currentSongFinished = savedFinished === 'true';
      
      console.log('æ¢å¤çŠ¶æ€:', { 
        currentIndex, 
        savedState, 
        savedTime, 
        currentSongFinished,
        fromNavigation 
      });
      
      // åˆ›å»ºéŸ³é¢‘å¯¹è±¡
      audio = new Audio(musicList[currentIndex]);
      audio.loop = false;
      audio.volume = 0.3;
      isInitialized = true;
      
      // è®¾ç½®æ’­æ”¾æ—¶é—´ç‚¹
      if (savedTime && !currentSongFinished) {
        audio.currentTime = parseFloat(savedTime);
      }
      
      // å¦‚æœæ­Œæ›²å·²æ’­æ”¾å®Œæ¯•ï¼ŒåŠ è½½ä½†ä¸æ’­æ”¾
      if (currentSongFinished) {
        console.log('å½“å‰æ­Œæ›²å·²æ’­æ”¾å®Œæ¯•ï¼Œç­‰å¾…æ’­æ”¾ä¸‹ä¸€é¦–');
        isPlaying = false;
        updateButtonStyle(false);
        
        // ç›‘å¬åŠ è½½å®Œæˆï¼Œç„¶åæš‚åœ
        audio.addEventListener('loadeddata', () => {
          if (!audio.paused) {
            audio.pause();
          }
        });
        
        audio.load();
      } else {
        // æ­Œæ›²æœªæ’­æ”¾å®Œæ¯•
        if (savedState === 'playing' && !fromNavigation) {
          // è‡ªåŠ¨æ’­æ”¾çš„æƒ…å†µ
          isPlaying = true;
          updateButtonStyle(true);
          setTimeout(() => {
            audio.play().catch(e => {
              console.log('è‡ªåŠ¨æ’­æ”¾éœ€è¦ç”¨æˆ·äº¤äº’:', e);
              isPlaying = false;
              updateButtonStyle(false);
            });
          }, 300);
        } else if (savedState === 'playing' && fromNavigation) {
          // é¡µé¢è·³è½¬è¿‡æ¥çš„æƒ…å†µï¼Œæš‚åœç­‰å¾…ç”¨æˆ·äº¤äº’
          isPlaying = false;
          updateButtonStyle(false);
          console.log('é¡µé¢è·³è½¬çŠ¶æ€ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»æ’­æ”¾');
        } else {
          // æš‚åœçŠ¶æ€
          isPlaying = false;
          updateButtonStyle(false);
        }
      }
      
    } catch (e) {
      console.log('åˆå§‹åŒ–å¤±è´¥:', e);
      // å¦‚æœæ¢å¤å¤±è´¥ï¼Œé‡æ–°å¼€å§‹
      currentIndex = Math.floor(Math.random() * musicList.length);
      audio = new Audio(musicList[currentIndex]);
      audio.loop = false;
      audio.volume = 0.3;
      isInitialized = true;
      isPlaying = false;
      updateButtonStyle(false);
    }
    
    // ç›‘å¬éŸ³é¢‘äº‹ä»¶
    audio.addEventListener('play', () => {
      isPlaying = true;
      currentSongFinished = false;
      updateButtonStyle(true);
      localStorage.setItem('music-state', 'playing');
      localStorage.setItem('music-finished', 'false');
      console.log('å¼€å§‹æ’­æ”¾');
    });
    
    audio.addEventListener('pause', () => {
      isPlaying = false;
      updateButtonStyle(false);
      if (!audio.ended) {
        localStorage.setItem('music-state', 'paused');
      }
      console.log('æš‚åœæ’­æ”¾');
    });
    
    audio.addEventListener('ended', () => {
      console.log('æ­Œæ›²æ’­æ”¾å®Œæ¯•');
      isPlaying = false;
      currentSongFinished = true;
      updateButtonStyle(false);
      
      // ä¿å­˜å®ŒæˆçŠ¶æ€
      localStorage.setItem('music-state', 'paused');
      localStorage.setItem('music-finished', 'true');
      localStorage.removeItem('music-time'); // æ¸…é™¤æ—¶é—´ï¼Œå› ä¸ºæ­Œæ›²å·²ç»“æŸ
      
      // ç­‰å¾…ç”¨æˆ·ç‚¹å‡»æ’­æ”¾ä¸‹ä¸€é¦–
      console.log('æ­Œæ›²å·²æ’­æ”¾å®Œæ¯•ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹ä¸‹ä¸€é¦–');
    });
    
    // ä¿å­˜æ’­æ”¾è¿›åº¦
    audio.addEventListener('timeupdate', () => {
      if (isPlaying && audio.currentTime > 0 && !currentSongFinished) {
        localStorage.setItem('music-time', audio.currentTime.toString());
        localStorage.setItem('music-index', currentIndex.toString());
      }
    });
    
    audio.addEventListener('error', (e) => {
      console.error('éŸ³é¢‘é”™è¯¯:', e);
      console.error('é”™è¯¯ä»£ç :', audio.error);
    });
  }
  
  // æ’­æ”¾ä¸‹ä¸€é¦–ï¼ˆåªåœ¨æ­Œæ›²æ’­æ”¾å®Œæ¯•åè°ƒç”¨ï¼‰
  function playNextSong() {
    if (!currentSongFinished) {
      console.log('å½“å‰æ­Œæ›²è¿˜æœªæ’­æ”¾å®Œæ¯•ï¼Œä¸èƒ½æ’­æ”¾ä¸‹ä¸€é¦–');
      return;
    }
    
    currentIndex = (currentIndex + 1) % musicList.length;
    currentSongFinished = false;
    
    console.log('å¼€å§‹æ’­æ”¾ä¸‹ä¸€é¦–:', musicList[currentIndex]);
    
    // åœæ­¢å½“å‰éŸ³é¢‘
    if (audio) {
      audio.pause();
    }
    
    // åˆ›å»ºæ–°çš„éŸ³é¢‘å¯¹è±¡
    audio = new Audio(musicList[currentIndex]);
    audio.loop = false;
    audio.volume = 0.3;
    
    // é‡ç½®äº‹ä»¶ç›‘å¬å™¨
    audio.addEventListener('play', () => {
      isPlaying = true;
      currentSongFinished = false;
      updateButtonStyle(true);
      localStorage.setItem('music-state', 'playing');
      localStorage.setItem('music-index', currentIndex.toString());
      localStorage.setItem('music-finished', 'false');
      console.log('å¼€å§‹æ’­æ”¾ä¸‹ä¸€é¦–');
    });
    
    audio.addEventListener('pause', () => {
      isPlaying = false;
      updateButtonStyle(false);
      if (!audio.ended) {
        localStorage.setItem('music-state', 'paused');
      }
    });
    
    audio.addEventListener('ended', () => {
      console.log('æ­Œæ›²æ’­æ”¾å®Œæ¯•');
      isPlaying = false;
      currentSongFinished = true;
      updateButtonStyle(false);
      localStorage.setItem('music-state', 'paused');
      localStorage.setItem('music-finished', 'true');
      localStorage.removeItem('music-time');
      console.log('æ­Œæ›²å·²æ’­æ”¾å®Œæ¯•ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹ä¸‹ä¸€é¦–');
    });
    
    audio.addEventListener('timeupdate', () => {
      if (isPlaying && audio.currentTime > 0 && !currentSongFinished) {
        localStorage.setItem('music-time', audio.currentTime.toString());
      }
    });
    
    // æ’­æ”¾æ–°æ­Œæ›²
    audio.play().catch(error => {
      console.log('æ’­æ”¾å¤±è´¥:', error);
      isPlaying = false;
      updateButtonStyle(false);
    });
  }
  
  // æ›´æ–°æŒ‰é’®æ ·å¼
  function updateButtonStyle(playing) {
    button.style.background = playing ? 'rgba(255, 174, 174, 0.4)' : 'white';
    button.style.borderColor = playing ? 'rgba(255, 174, 174, 0.8)' : 'rgba(255, 174, 174, 0.443)';
    button.textContent = 'ğŸµ';
  }
  
  // æ’­æ”¾/æš‚åœéŸ³ä¹
  function toggleMusic() {
    if (!isInitialized) {
      initAudio();
    }
    
    // æ¸…é™¤é¡µé¢è·³è½¬æ ‡è®°ï¼ˆç”¨æˆ·å·²äº¤äº’ï¼‰
    if (isFromNavigation) {
      isFromNavigation = false;
      sessionStorage.removeItem('music-from-navigation');
      console.log('æ¸…é™¤é¡µé¢è·³è½¬æ ‡è®°ï¼Œç”¨æˆ·å·²äº¤äº’');
    }
    
    if (currentSongFinished) {
      // å½“å‰æ­Œæ›²å·²æ’­æ”¾å®Œæ¯•ï¼Œæ’­æ”¾ä¸‹ä¸€é¦–
      console.log('æ’­æ”¾ä¸‹ä¸€é¦–æ­Œæ›²');
      playNextSong();
    }else {
      // æ’­æ”¾éŸ³ä¹
      audio.play().catch(error => {
        console.log('æ’­æ”¾å¤±è´¥:', error);
        // æç¤ºç”¨æˆ·
        if (error.name === 'NotAllowedError') {
          button.style.background = '#ffcccc';
          button.textContent = 'ğŸ”‡';
          setTimeout(() => updateButtonStyle(false), 1000);
        }
      });
    }
  }
  
  // é¡µé¢å¸è½½æ—¶ä¿å­˜çŠ¶æ€å¹¶æš‚åœ
  function handleBeforeUnload() {
    console.log('é¡µé¢å¸è½½ï¼Œä¿å­˜çŠ¶æ€å¹¶æš‚åœ');
    
    // æ ‡è®°ä¸ºé¡µé¢è·³è½¬
    markAsNavigation();
    
    if (audio) {
      // ä¿å­˜å½“å‰æ’­æ”¾è¿›åº¦
      if (!currentSongFinished && audio.currentTime > 0) {
        localStorage.setItem('music-time', audio.currentTime.toString());
      }
      localStorage.setItem('music-index', currentIndex.toString());
      localStorage.setItem('music-state', isPlaying ? 'playing' : 'paused');
      localStorage.setItem('music-finished', currentSongFinished ? 'true' : 'false');
      
      // æš‚åœéŸ³ä¹
      if (!audio.paused) {
        audio.pause();
        console.log('é¡µé¢è·³è½¬ï¼Œæš‚åœéŸ³ä¹');
      }
    }
  }
  
  // åˆå§‹åŒ–
  initAudio();
  
  // ç»‘å®šç‚¹å‡»äº‹ä»¶
  button.addEventListener('click', toggleMusic);
  
  // ç›‘å¬é¡µé¢å¸è½½
  window.addEventListener('beforeunload', handleBeforeUnload);
  
  // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && audio && !audio.paused) {
      console.log('é¡µé¢éšè—ï¼Œä¿å­˜çŠ¶æ€');
      // é¡µé¢ä¸å¯è§æ—¶ï¼Œä¿å­˜å½“å‰çŠ¶æ€
      localStorage.setItem('music-time', audio.currentTime.toString());
    }
  });
  
  // åˆå§‹åŒ–æŒ‰é’®æ ·å¼
  updateButtonStyle(isPlaying);
  
  console.log('éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ');
})();
</script>