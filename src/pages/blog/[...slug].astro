---
// src/pages/blog/[...slug].astro
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection, getEntry } from 'astro:content';
import '../../styles/mddisplay.css';

const PROTECTED_POSTS = {
  '个体/violinsheetmusic': 'ok',
};

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { preloadedEntry: post }
  }));
}

const { preloadedEntry } = Astro.props;
const { slug } = Astro.params;

let entry;
if (preloadedEntry) {
  entry = preloadedEntry;
} else {
  entry = await getEntry('blog', slug);
  if (!entry) {
    return Astro.redirect('/404');
  }
}

const { Content } = await entry.render();

const isProtected = PROTECTED_POSTS[entry.slug];
---

<BaseLayout title={entry.data.title}>
  <div class="article-container">
    <main class="max-w-3xl mx-auto px-4 py-16">
      <article>
        <div class="markdown-wrapper">
          <div class="markdown-content">
            {!isProtected ? (
              <>
                <h1 class="text-3xl font-bold mb-6">{entry.data.title}</h1>
                <div class="prose prose-lg max-w-none">
                  <Content />
                </div>
              </>
            ) : (
              <>
                <div id="article-content" style="display: none;">
                  <h1 class="text-3xl font-bold mb-6">{entry.data.title}</h1>
                  <div class="prose prose-lg max-w-none">
                    <Content />
                  </div>
                </div>
                
                <div id="password-form">
                  <div style="text-align: center; padding: 100px 20px;">
                    <h2 style="margin-bottom: 20px;">需要密码</h2>
                    <div style="max-width: 300px; margin: 0 auto;">
                      <input 
                        type="password" 
                        id="pwd-input" 
                        placeholder="输入密码"
                        style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px;"
                      />
                      <button onclick="checkPassword()" style="width: 100%; padding: 12px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        进入
                      </button>
                      <div id="error-msg" style="color: red; margin-top: 10px; min-height: 20px;"></div>
                    </div>
                  </div>
                </div>
              </>
            )}
          </div>
        </div>
      </article>
    </main>
  </div>

  {isProtected && (
    <script is:inline>
      // 从对象中获取密码
      const PROTECTED_POSTS = {
        '个体/violinsheetmusic': 'ok',
      };
      
      // 获取当前页面的slug（从URL推断）
      const currentSlug = window.location.pathname.split('/').slice(2).join('/');
      const CORRECT_PASSWORD = PROTECTED_POSTS[currentSlug] || 'ok';
      
      // 检查URL参数
      const urlParams = new URLSearchParams(window.location.search);
      const urlPassword = urlParams.get('p');
      
      if (urlPassword === CORRECT_PASSWORD) {
        document.getElementById('article-content').style.display = 'block';
        document.getElementById('password-form').style.display = 'none';
      } else {
        document.getElementById('article-content').style.display = 'none';
        document.getElementById('password-form').style.display = 'block';
        document.getElementById('pwd-input').focus();
      }
      
      function checkPassword() {
        const input = document.getElementById('pwd-input');
        const errorMsg = document.getElementById('error-msg');
        
        if (input.value === CORRECT_PASSWORD) {
          window.location.href = window.location.pathname + '?p=' + encodeURIComponent(CORRECT_PASSWORD);
        } else {
          errorMsg.textContent = '密码错误。';
          setTimeout(() => {
            errorMsg.textContent = '';
          }, 3000);
        }
      }
      
      document.getElementById('pwd-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          checkPassword();
        }
      });
    </script>
  )}
</BaseLayout>