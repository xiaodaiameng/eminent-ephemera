---
// src/pages/blog/[...slug].astro
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  try {
    const posts = await getCollection('blog');
    
    // è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥è·å–åˆ°çš„æ–‡ç« 
    console.log('=== DEBUG: getStaticPaths ===');
    console.log('Total posts found:', posts.length);
    posts.forEach((post, index) => {
      console.log(`Post ${index + 1}:`, {
        id: post.id,
        slug: post.slug,
        hasData: !!post.data,
        dataKeys: post.data ? Object.keys(post.data) : 'no data'
      });
    });
    
    return posts.map(post => ({
      params: { 
        slug: post.slug 
      },
      props: { 
        post,
        debugInfo: {
          id: post.id,
          slug: post.slug
        }
      },
    }));
  } catch (error) {
    console.error('Error in getStaticPaths:', error);
    return [];
  }
}

const { post, debugInfo } = Astro.props;

// è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥æ¥æ”¶åˆ°çš„ props
console.log('=== DEBUG: Component Props ===');
console.log('URL Slug:', Astro.params.slug);
console.log('Debug Info:', debugInfo);
console.log('Post object:', post);
console.log('Has post?', !!post);
console.log('Post ID:', post?.id);
console.log('Post data:', post?.data);

// å…³é”®æ£€æŸ¥ï¼šç¡®ä¿ post å­˜åœ¨
if (!post) {
  console.error('âŒ ERROR: Post is undefined for slug:', Astro.params.slug);
  console.error('Redirecting to 404 page');
  return Astro.redirect('/404');
}

// æ£€æŸ¥ post æ˜¯å¦æœ‰å¿…è¦çš„ç»“æ„
if (!post.data || !post.id) {
  console.error('âŒ ERROR: Post has invalid structure:', post);
  return Astro.redirect('/404');
}

// å®‰å…¨åœ°æ¸²æŸ“å†…å®¹
let Content;
try {
  console.log('Attempting to render post:', post.id);
  const renderResult = await post.render();
  
  if (!renderResult) {
    throw new Error('Render result is null or undefined');
  }
  
  if (!renderResult.Content) {
    throw new Error('Render result has no Content property');
  }
  
  Content = renderResult.Content;
  console.log('âœ… Post rendered successfully');
} catch (renderError) {
  console.error('âŒ Failed to render post:', post.id);
  console.error('Render error:', renderError);
  console.error('Post data for debugging:', {
    id: post.id,
    slug: post.slug,
    data: post.data,
    body: post.body ? 'has body' : 'no body'
  });
  
  // è¿”å›é”™è¯¯é¡µé¢æˆ–é‡å®šå‘
  return Astro.redirect('/404');
}
---

<!-- æ·»åŠ ä¸€äº›é¢å¤–çš„è°ƒè¯•æ˜¾ç¤ºï¼ˆä»…åœ¨å¼€å‘ç¯å¢ƒï¼‰ -->
{import.meta.env.DEV && (
  <div class="bg-yellow-100 dark:bg-yellow-900 p-4 rounded-lg mb-4">
    <p class="font-bold">ğŸ› ï¸ è°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘æ¨¡å¼ï¼‰</p>
    <p>æ–‡ç« ID: {post.id}</p>
    <p>Slug: {post.slug}</p>
    <p>æ ‡é¢˜: {post.data.title}</p>
  </div>
)}

<BaseLayout 
  title={post.data.title} 
  description={post.data.description}
>
  <article class="max-w-4xl mx-auto">
    <!-- æ–‡ç« å¤´éƒ¨ -->
    <header class="mb-8">
      <div class="flex items-center gap-2 text-sm mb-4">
        <span class={`badge ${
          post.data.category === 'study' ? 'badge-primary' :
          post.data.category === 'social' ? 'badge-secondary' :
          'badge-accent'
        }`}>
          {post.data.category === 'study' ? 'å­¦ä¹ å·¥ä½œ' :
           post.data.category === 'social' ? 'ç¤¾ä¼šæ´»åŠ¨' : 'ä¸ªäººæ€æƒ³'}
        </span>
        <span class="opacity-70">
          {new Date(post.data.date).toLocaleDateString('zh-CN')}
        </span>
      </div>
      
      <h1 class="text-4xl md:text-5xl font-bold mb-4">{post.data.title}</h1>
      <p class="text-xl opacity-70 mb-6">{post.data.description}</p>
      
      {post.data.image && (
        <img 
          src={post.data.image} 
          alt={post.data.title}
          class="w-full h-64 md:h-96 object-cover rounded-lg mb-6"
          loading="lazy"
        />
      )}
    </header>
    
    <!-- æ–‡ç« å†…å®¹ -->
    <div class="prose prose-lg max-w-none dark:prose-invert">
      {Content && <Content />}
    </div>
    
    <!-- æ ‡ç­¾ -->
    {post.data.tags && post.data.tags.length > 0 && (
      <div class="mt-8 pt-6 border-t dark:border-gray-700">
        <div class="flex flex-wrap gap-2">
          {post.data.tags.map(tag => (
            <a 
              href={`/blog?tag=${tag}`}
              class="badge badge-outline hover:badge-primary transition-colors"
            >
              #{tag}
            </a>
          ))}
        </div>
      </div>
    )}
    
    <!-- å¯¼èˆª -->
    <div class="mt-8 flex justify-between gap-4">
      <a href="/blog" class="btn btn-outline flex-1 text-center">
        â† è¿”å›åšå®¢åˆ—è¡¨
      </a>
      <a href="/" class="btn btn-outline flex-1 text-center">
        è¿”å›é¦–é¡µ â†’
      </a>
    </div>
  </article>
</BaseLayout>