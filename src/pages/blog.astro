---
// src/pages/blog.astro
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import PostCard from '../components/blog/PostCard.astro';
import TagCloud from '../components/blog/TagCloud.astro';
import TimeMachine from '../components/blog/TimeMachine.astro';
const posts = await getCollection('blog', ({ data }) => !data.draft);
const tags = [...new Set(posts.flatMap(post => post.data.tags))];
const categories = {
  study: posts.filter(post => post.data.category === 'study'),
  social: posts.filter(post => post.data.category === 'social'),
  personal: posts.filter(post => post.data.category === 'personal'),
};

// è·å–æŸ¥è¯¢å‚æ•°
const searchParams = Astro.url.searchParams;
const selectedCategory = searchParams.get('category');
const selectedTag = searchParams.get('tag');

let filteredPosts = posts;
if (selectedCategory) {
  filteredPosts = posts.filter(post => post.data.category === selectedCategory);
} else if (selectedTag) {
  filteredPosts = posts.filter(post => post.data.tags.includes(selectedTag));
}

// æŒ‰æ—¥æœŸæ’åº
filteredPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
---

<BaseLayout title="åšå®¢æ–‡ç« " description="åˆ†äº«æˆ‘çš„å­¦ä¹ å·¥ä½œã€ç¤¾ä¼šæ´»åŠ¨å’Œä¸ªäººæ€è€ƒ">
  <div class="max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- ä¾§è¾¹æ  -->
      <aside class="lg:col-span-1 space-y-6">
        <div class="card bg-base-200">
          <div class="card-body">
            <h3 class="card-title">åˆ†ç±»</h3>
            <div class="space-y-2">
              <a href="/blog" class={`block p-2 rounded ${!selectedCategory ? 'bg-primary' : 'hover:bg-base-300'}`}>
                å…¨éƒ¨æ–‡ç«  ({posts.length})
              </a>
              <a href="/blog?category=study" class={`block p-2 rounded ${selectedCategory === 'study' ? 'bg-primary' : 'hover:bg-base-300'}`}>
                å­¦ä¹ å·¥ä½œ ({categories.study.length})
              </a>
              <a href="/blog?category=social" class={`block p-2 rounded ${selectedCategory === 'social' ? 'bg-primary' : 'hover:bg-base-300'}`}>
                ç¤¾ä¼šæ´»åŠ¨ ({categories.social.length})
              </a>
              <a href="/blog?category=personal" class={`block p-2 rounded ${selectedCategory === 'personal' ? 'bg-primary' : 'hover:bg-base-300'}`}>
                ä¸ªäººæ€æƒ³ ({categories.personal.length})
              </a>
            </div>
          </div>
        </div>
        
        <TagCloud tags={tags} selectedTag={selectedTag} />
        
        <div class="card bg-base-200">
          <div class="card-body">
            <h3 class="card-title">å½’æ¡£</h3>
            <TimeMachine />
          </div>
        </div>
      </aside>
      
      <!-- ä¸»å†…å®¹åŒº -->
      <main class="lg:col-span-3">
        
        {filteredPosts.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {filteredPosts.map(post => (
              <PostCard post={post} />
            ))}
          </div>
        ) : (
          <div class="text-center py-12">
            <div class="text-6xl mb-4">ğŸ“</div>
            <h3 class="text-2xl font-semibold mb-2">æš‚æ— æ–‡ç« </h3>
            <p class="opacity-70">è¯¥åˆ†ç±»ä¸‹è¿˜æ²¡æœ‰æ–‡ç« å“¦~</p>
          </div>
        )}
      </main>
    </div>
  </div>
</BaseLayout>