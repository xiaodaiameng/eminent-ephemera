---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// 获取所有文章
const allPosts = await getCollection('blog');

// 按分类分组
const categorizedPosts = {
  学习: [],
  个体: [],
  社交: []
};

// 获取文件修改时间的函数
async function getFileModifiedTime(slug, postData) {  // 添加 postData 参数
  try {
    // 只在 Node.js 环境下使用 fs
    if (typeof process === 'undefined' || !process.versions.node) {
      return postData.pubDate || new Date();
    }
    
    const fs = await import('fs/promises');
    const path = await import('path');
    
    // 重要修改：slug 已经包含子目录路径，直接构建完整路径
    const filePath = path.join(process.cwd(), 'src/content/blog', `${slug}.md`);
    
    try {
      const stats = await fs.stat(filePath);
      return stats.mtime; // 返回文件的最后修改时间
    } catch (error) {
      // 如果找不到文件，返回发布日期
      console.warn(`无法找到文件: ${filePath}, 使用发布日期`);
      return postData.pubDate || new Date();
    }
  } catch {
    return postData.pubDate || new Date();
  }
}

// 处理所有文章
const postsWithTime = await Promise.all(
  allPosts.map(async (post) => {
    const lastModified = await getFileModifiedTime(post.slug, post.data);
    return {
      ...post,
      lastModified
    };
  })
);

// 按分类分组
for (const post of postsWithTime) {
  const category = post.slug.split('/')[0];
  if (categorizedPosts[category]) {
    categorizedPosts[category].push(post);
  }
}

// 按修改时间倒序排序
for (const category in categorizedPosts) {
  categorizedPosts[category].sort((a, b) => 
    b.lastModified.getTime() - a.lastModified.getTime()
  );
}
---

<BaseLayout title="分类后在内部按时间归档" description="分享学习工作、社会活动和个人思考">

<main>
  <br><br>
  <!-- 学习分类 -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold mb-4">学习</h2>
    <ul class="space-y-3">
      {categorizedPosts.学习.map(post => (
        <li class="border-l-4 border-blue-500 pl-4 py-1">
          <a 
            href={`/blog/${post.slug}`}
            class="text-lg hover:text-blue-500 transition-colors"
          >
            {post.data.title}
          </a>
          <span class="text-sm text-gray-500 ml-2">
            （最后更新：{post.lastModified.toLocaleDateString('zh-CN')}）
          </span>
        </li>
      ))}
    </ul>
  </section>

  <!-- 个体分类 -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold mb-4">个体</h2>
    <ul class="space-y-3">
      {categorizedPosts.个体.map(post => (
        <li class="border-l-4 border-green-500 pl-4 py-1">
          <a 
            href={`/blog/${post.slug}`}
            class="text-lg hover:text-green-500 transition-colors"
          >
            {post.data.title}
          </a>
          <span class="text-sm text-gray-500 ml-2">
            （最后更新：{post.lastModified.toLocaleDateString('zh-CN')}）
          </span>
        </li>
      ))}
    </ul>
  </section>

  <!-- 社交分类 -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold mb-4">社交</h2>
    <ul class="space-y-3">
      {categorizedPosts.社交.map(post => (
        <li class="border-l-4 border-purple-500 pl-4 py-1">
          <a 
            href={`/blog/${post.slug}`}
            class="text-lg hover:text-purple-500 transition-colors"
          >
            {post.data.title}
          </a>
          <span class="text-sm text-gray-500 ml-2">
            （最后更新：{post.lastModified.toLocaleDateString('zh-CN')}）
          </span>
        </li>
      ))}
    </ul>
  </section>
</main>
</BaseLayout>