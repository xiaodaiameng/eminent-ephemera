---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// 获取所有文章
const allPosts = await getCollection('blog');

// 按分类分组
const categorizedPosts = {
  学习: [],
  个体: [],
  社交: []
};

// 处理所有文章 - 修复时间问题
const postsWithTime = allPosts.map((post) => {
  // 关键：将字符串日期转换为 Date 对象
  let created = new Date();
  let lastModified = new Date();
  
  if (post.data.pubDate) {
    // 处理 pubDate（可能是字符串或 Date 对象）
    created = post.data.pubDate instanceof Date 
      ? post.data.pubDate 
      : new Date(post.data.pubDate);
  }
  
  if (post.data.updated) {
    // 处理 updated（可能是字符串或 Date 对象）
    lastModified = post.data.updated instanceof Date
      ? post.data.updated
      : new Date(post.data.updated);
  } else {
    lastModified = created;
  }
  
  return {
    ...post,
    created,
    lastModified
  };
});

// 按分类分组
for (const post of postsWithTime) {
  const category = post.slug.split('/')[0];
  if (categorizedPosts[category]) {
    categorizedPosts[category].push(post);
  }
}

// 按修改时间倒序排序
for (const category in categorizedPosts) {
  categorizedPosts[category].sort((a, b) => 
    b.lastModified.getTime() - a.lastModified.getTime()
  );
}
---

<BaseLayout title="分类后在内部按时间归档" description="分享学习工作、社会活动和个人思考">

<main>
  <br><br>
  <!-- 学习分类 -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold mb-4">学习</h2>
    <ul class="space-y-3">
      {categorizedPosts.学习.map(post => (
        <li class="border-l-4 border-blue-500 pl-4 py-1">
          <a 
            href={`/blog/${post.slug}`}
            class="text-lg hover:text-blue-500 transition-colors"
          >
            {post.data.title}
          </a>
          <span class="text-sm text-gray-500 ml-2">
            （更新：{post.lastModified.toLocaleDateString('zh-CN')}）
          </span>
        </li>
      ))}
    </ul>
  </section>

  <!-- 个体分类 -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold mb-4">个体</h2>
    <ul class="space-y-3">
      {categorizedPosts.个体.map(post => (
        <li class="border-l-4 border-green-500 pl-4 py-1">
          <a 
            href={`/blog/${post.slug}`}
            class="text-lg hover:text-green-500 transition-colors"
          >
            {post.data.title}
          </a>
          <span class="text-sm text-gray-500 ml-2">
            （更新：{post.lastModified.toLocaleDateString('zh-CN')}）
          </span>
        </li>
      ))}
    </ul>
  </section>

  <!-- 社交分类 -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold mb-4">社交</h2>
    <ul class="space-y-3">
      {categorizedPosts.社交.map(post => (
        <li class="border-l-4 border-purple-500 pl-4 py-1">
          <a 
            href={`/blog/${post.slug}`}
            class="text-lg hover:text-purple-500 transition-colors"
          >
            {post.data.title}
          </a>
          <span class="text-sm text-gray-500 ml-2">
            （更新：{post.lastModified.toLocaleDateString('zh-CN')}）
          </span>
        </li>
      ))}
    </ul>
  </section>
</main>
</BaseLayout>