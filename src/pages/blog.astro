---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// 获取所有文章
const allPosts = await getCollection('blog');

// 按分类分组
const categorizedPosts = {
  学习: [],
  个体: [],
  社交: []
};

// 使用 Git 获取文件创建和修改时间
async function getGitFileTimes(slug) {
  // 只在 Node.js 环境下
  if (typeof process === 'undefined' || !process.versions.node) {
    return { created: new Date(), modified: new Date() };
  }
  
  try {
    const { execSync } = await import('child_process');
    const path = await import('path');
    
    // 构建文件相对路径
    const filePath = path.join('src/content/blog', `${slug}.md`);
    
    // 获取最后修改时间（最后一次提交）
    let modified = new Date();
    try {
      const modCommand = `git log -1 --format="%ad" --date=iso-strict -- "${filePath}"`;
      const modResult = execSync(modCommand, { encoding: 'utf-8' }).trim();
      if (modResult) modified = new Date(modResult);
    } catch {}
    
    // 获取创建时间（第一次提交）
    let created = modified;
    try {
      const createCommand = `git log --format="%ad" --date=iso-strict --reverse -- "${filePath}" | head -1`;
      const createResult = execSync(createCommand, { encoding: 'utf-8' }).trim();
      if (createResult) created = new Date(createResult);
    } catch {}
    
    return { created, modified };
    
  } catch (error) {
    console.warn(`无法获取 Git 时间: ${slug}`, error.message);
    return { created: new Date(), modified: new Date() };
  }
}

// 处理所有文章
const postsWithTime = await Promise.all(
  allPosts.map(async (post) => {
    const times = await getGitFileTimes(post.slug);
    return {
      ...post,
      created: times.created,
      lastModified: times.modified
    };
  })
);

// 按分类分组
for (const post of postsWithTime) {
  const category = post.slug.split('/')[0];
  if (categorizedPosts[category]) {
    categorizedPosts[category].push(post);
  }
}

// 按修改时间倒序排序
for (const category in categorizedPosts) {
  categorizedPosts[category].sort((a, b) => 
    b.lastModified.getTime() - a.lastModified.getTime()
  );
}
---

<BaseLayout title="分类后在内部按时间归档" description="分享学习工作、社会活动和个人思考">

<main>
  <br><br>
  <!-- 学习分类 -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold mb-4">学习</h2>
    <ul class="space-y-3">
      {categorizedPosts.学习.map(post => (
        <li class="border-l-4 border-blue-500 pl-4 py-1">
          <a 
            href={`/blog/${post.slug}`}
            class="text-lg hover:text-blue-500 transition-colors"
          >
            {post.data.title}
          </a>
          <span class="text-sm text-gray-500 ml-2">
            （更新：{post.lastModified.toLocaleDateString('zh-CN')}）
          </span>
        </li>
      ))}
    </ul>
  </section>

  <!-- 个体分类 -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold mb-4">个体</h2>
    <ul class="space-y-3">
      {categorizedPosts.个体.map(post => (
        <li class="border-l-4 border-green-500 pl-4 py-1">
          <a 
            href={`/blog/${post.slug}`}
            class="text-lg hover:text-green-500 transition-colors"
          >
            {post.data.title}
          </a>
          <span class="text-sm text-gray-500 ml-2">
            （更新：{post.lastModified.toLocaleDateString('zh-CN')}）
          </span>
        </li>
      ))}
    </ul>
  </section>

  <!-- 社交分类 -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold mb-4">社交</h2>
    <ul class="space-y-3">
      {categorizedPosts.社交.map(post => (
        <li class="border-l-4 border-purple-500 pl-4 py-1">
          <a 
            href={`/blog/${post.slug}`}
            class="text-lg hover:text-purple-500 transition-colors"
          >
            {post.data.title}
          </a>
          <span class="text-sm text-gray-500 ml-2">
            （更新：{post.lastModified.toLocaleDateString('zh-CN')}）
          </span>
        </li>
      ))}
    </ul>
  </section>
</main>
</BaseLayout>